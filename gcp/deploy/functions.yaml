# ================================================================
# Cloud Run Functions -- Deployment Configuration
# ================================================================
# Single source of truth for all function deploy settings.
# Add new functions as entries under `functions:`.
# ================================================================

global:
  project: dkg-phd-thesis
  region: us-east4
  runtime: python312
  gen2: true

functions:
  run-qualtrics-scheduling:
    source_dir: run_qualtrics_scheduling
    poetry_group: fn-qualtrics-scheduling
    entry_point: qualtrics_webhook_handler
    trigger: http
    allow_unauthenticated: false
    service_account:
      name: dkg-fn-qualtrics
      display_name: "Cloud Run -- Qualtrics Scheduling Function"
      roles:
        - roles/bigquery.dataEditor
        - roles/bigquery.jobUser
        - roles/pubsub.publisher
        # - roles/secretmanager.secretAccessor
    # secrets:
    #   - QUALTRICS_API_KEY=dkg-qualtrics-api-key:latest
    #   - QUALTRICS_WEBHOOK_SECRET=dkg-qualtrics-webhook-secret:latest

  run-intake-confirmation:
    source_dir: run_intake_confirmation
    poetry_group: fn-intake-confirmation
    entry_point: intake_confirmation_handler
    trigger: topic
    trigger_topic: dkg-intake-processed
    allow_unauthenticated: false
    secrets:
      - TWILIO_CONFIG=dkg-twilio-config:latest
    service_account:
      name: dkg-fn-intake-confirm
      display_name: "Cloud Run -- Intake Confirmation Function"
      roles:
        - roles/bigquery.dataEditor
        - roles/bigquery.jobUser
        - roles/run.invoker
        - roles/secretmanager.secretAccessor

  # -- Future functions ----------------------------------------------
  # run-twilio-handler:
  #   source_dir: run_twilio_handler
  #   poetry_group: fn-twilio-handler
  #   entry_point: twilio_webhook_handler
  #   trigger: http
  #   allow_unauthenticated: false
  #   secrets:
  #     - TWILIO_AUTH_TOKEN=dkg-twilio-auth-token:latest
  #   service_account:
  #     name: dkg-fn-twilio
  #     display_name: "Cloud Run -- Twilio Handler Function"
  #     roles:
  #       - roles/bigquery.dataEditor
  #       - roles/secretmanager.secretAccessor